use crate::datatypes::api::file_id::FileId;
use once_cell::sync::Lazy;
use regex::Regex;

/// Find the video id in the response (which is streamed, appended JSON)
// {\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\"
static JSON_REGEX: Lazy<Regex> = Lazy::new(|| {
  // NB: Should be a 36 character UUID.
  Regex::new(r#"\\?"videoI[dD]\\?":\s*\\?"([a-zA-Z0-9-]{25,})\\?",?"#)
      .expect("Regex should parse")
});

/// Parse the video ID from the response
pub fn parse_video_id(html: &str) -> Option<FileId> {
  let maybe_meta = scrape_video_id_via_regex(html);

  if let Some(meta) = maybe_meta {
    return Some(FileId(meta))
  }

  None
}

fn scrape_video_id_via_regex(html: &str) -> Option<String> {
  let captures = JSON_REGEX.captures(html)?;
  let capture = captures.get(1)?;
  Some(capture.as_str().to_string())
}

#[cfg(test)]
mod tests {
  use crate::requests::video_chat::parse_video_id::parse_video_id;
  use errors::AnyhowResult;

  const PAYLOAD : &str = r#"{\"result\":{\"conversation\":{\"conversationId\":\"ba9499ba-4a59-46f5-8d41-a04c527c1693\",\"title\":\"New conversation\",\"starred\":false,\"createTime\":\"2025-10-30T19:04:27.650012Z\",\"modifyTime\":\"2025-10-30T19:04:27.652930Z\",\"systemPromptName\":\"\",\"temporary\":true,\"mediaTypes\":[],\"workspaces\":[],\"taskResult\":null}}}\n{\"result\":{\"response\":{\"userResponse\":{\"responseId\":\"62d85bb5-746f-45e1-9a9e-40f8a9ef2a3e\",\"message\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content  our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero --mode=custom\",\"sender\":\"human\",\"createTime\":\"2025-10-30T19:04:27.706802818Z\",\"manual\":false,\"partial\":false,\"shared\":false,\"query\":\"\",\"queryType\":\"\",\"webSearchResults\":[],\"xpostIds\":[],\"xposts\":[],\"generatedImageUrls\":[],\"imageAttachments\":[],\"fileAttachments\":[\"eabcc2a5-8a9b-4382-82d2-020b4b286e87\"],\"cardAttachmentsJson\":[],\"fileUris\":[],\"fileAttachmentsMetadata\":[],\"isControl\":false,\"steps\":[],\"imageEditUris\":[],\"mediaTypes\":[],\"webpageUrls\":[],\"metadata\":{\"modelConfigOverride\":{\"modelMap\":{\"videoGenModelConfig\":{\"parentPostId\":\"eabcc2a5-8a9b-4382-82d2-020b4b286e87\"}}}},\"citedWebSearchResults\":[],\"toolResponses\":[],\"model\":\"grok-3\",\"ragResults\":[],\"citedRagResults\":[],\"searchProductResults\":[]},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"62d85bb5-746f-45e1-9a9e-40f8a9ef2a3e\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":1,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":5,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":14,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":23,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":32,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":42,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":52,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":95,\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"streamingVideoGenerationResponse\":{\"videoId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"progress\":100,\"assetId\":\"34fa0313-3cde-4693-b046-319093374dbe\",\"videoUrl\":\"users/85980643-ffab-4984-a3de-59a608c47d7f/generated/34fa0313-3cde-4693-b046-319093374dbe/generated_video.mp4\",\"audioUrls\":[],\"videoPrompt\":\"our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero\",\"imageReference\":\"https://assets.grok.com/users/85980643-ffab-4984-a3de-59a608c47d7f/eabcc2a5-8a9b-4382-82d2-020b4b286e87/content\",\"audioTranscripts\":[],\"moderated\":false,\"mode\":\"custom\",\"modelName\":\"imagine_xdit_1\",\"thumbnailImageUrl\":\"users/85980643-ffab-4984-a3de-59a608c47d7f/generated/34fa0313-3cde-4693-b046-319093374dbe/preview_image.jpg\"},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"token\":\"I generated a video with the prompt: 'our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero'\",\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"token\":\"\",\"isThinking\":false,\"isSoftStop\":true,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"response\":{\"modelResponse\":{\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\",\"message\":\"I generated a video with the prompt: 'our hero link on horseback galloping through the fantasy world, bright sun behind him. a dormant volcano has a circling ring of smoke. the camera pulls back and follows our hero'\",\"sender\":\"ASSISTANT\",\"createTime\":\"2025-10-30T19:04:52.510270096Z\",\"parentResponseId\":\"62d85bb5-746f-45e1-9a9e-40f8a9ef2a3e\",\"manual\":false,\"partial\":false,\"shared\":false,\"query\":\"\",\"queryType\":\"\",\"webSearchResults\":[],\"xpostIds\":[],\"xposts\":[],\"generatedImageUrls\":[],\"imageAttachments\":[],\"fileAttachments\":[\"34fa0313-3cde-4693-b046-319093374dbe\"],\"cardAttachmentsJson\":[],\"fileUris\":[],\"fileAttachmentsMetadata\":[],\"isControl\":false,\"steps\":[],\"imageEditUris\":[],\"mediaTypes\":[],\"webpageUrls\":[],\"metadata\":{\"deepsearchPreset\":\"\",\"request_metadata\":{\"effort\":\"low\",\"mode\":\"fast\",\"model\":\"grok-3\"},\"request_trace_id\":\"5447a9522af26a244b86bdaef90e4a25\"},\"citedWebSearchResults\":[],\"toolResponses\":[],\"model\":\"grok-3\",\"requestMetadata\":{\"model\":\"grok-3\",\"mode\":\"MODEL_MODE_FAST\",\"effort\":\"LOW\"},\"ragResults\":[],\"citedRagResults\":[],\"searchProductResults\":[]},\"isThinking\":false,\"isSoftStop\":false,\"responseId\":\"791ddc68-d4c1-4e37-95d1-88ad9c7903dc\"}}}\n{\"result\":{\"title\":{\"newTitle\":\"Video Generation: Fantasy Hero Journey\"}}}\n"#;

  #[test]
  fn test() -> AnyhowResult<()> {
    let video_id = parse_video_id(PAYLOAD).unwrap();
    let expected = "34fa0313-3cde-4693-b046-319093374dbe";
    assert_eq!(&video_id.0, expected);
    Ok(())
  }
}
