use crate::core::api_adapters::aspect_ratio::convert::aspect_ratio_to_artcraft_flux_pro_1p1::aspect_ratio_to_artcraft_flux_pro_1p1;
use crate::core::api_adapters::aspect_ratio::convert::aspect_ratio_to_artcraft_flux_pro_1p1_ultra::aspect_ratio_to_artcraft_flux_pro_1p1_ultra;
use crate::core::commands::enqueue::generate_error::GenerateError;
use crate::core::commands::enqueue::task_enqueue_success::TaskEnqueueSuccess;
use crate::core::commands::enqueue::text_to_image::enqueue_text_to_image_command::{EnqueueTextToImageRequest, TextToImageSize};
use crate::core::events::generation_events::common::GenerationModel;
use crate::core::state::app_env_configs::app_env_configs::AppEnvConfigs;
use crate::services::storyteller::state::storyteller_credential_manager::StorytellerCredentialManager;
use artcraft_api_defs::generate::image::text::generate_flux_pro_11_ultra_text_to_image::{GenerateFluxPro11UltraTextToImageAspectRatio, GenerateFluxPro11UltraTextToImageNumImages, GenerateFluxPro11UltraTextToImageRequest};
use enums::common::generation_provider::GenerationProvider;
use enums::tauri::tasks::task_type::TaskType;
use idempotency::uuid::generate_random_uuid;
use log::{error, info};
use artcraft_client::endpoints::generate::image::text::generate_flux_pro_11_ultra_text_to_image::generate_flux_pro_11_ultra_text_to_image;

pub async fn handle_artcraft_flux_pro_1p1_ultra_text_to_image(
  request: &EnqueueTextToImageRequest,
  app_env_configs: &AppEnvConfigs,
  storyteller_creds_manager: &StorytellerCredentialManager,
) -> Result<TaskEnqueueSuccess, GenerateError> {

  let creds = match storyteller_creds_manager.get_credentials()? {
    Some(creds) => creds,
    None => {
      return Err(GenerateError::needs_storyteller_credentials());
    },
  };

  info!("enqueue Flux Pro 1.1 Ultra");

  let uuid_idempotency_token = generate_random_uuid();
  
  let request = GenerateFluxPro11UltraTextToImageRequest {
    uuid_idempotency_token,
    prompt: request.prompt.clone(),
    aspect_ratio: get_aspect_ratio(request),
    num_images: request.number_images
        .and_then(|num| match num {
          1 => Some(GenerateFluxPro11UltraTextToImageNumImages::One),
          2 => Some(GenerateFluxPro11UltraTextToImageNumImages::Two),
          3 => Some(GenerateFluxPro11UltraTextToImageNumImages::Three),
          4 => Some(GenerateFluxPro11UltraTextToImageNumImages::Four),
          _ => None, // NB: use service defaults
        }),
  };
  
  let result = generate_flux_pro_11_ultra_text_to_image(
    &app_env_configs.storyteller_host,
    Some(&creds),
    request,
  ).await;
  
  let job_token = match result {
    Ok(enqueued) => {
      info!("Successfully enqueued Artcraft Flux Pro 1.1 Ultra text to image generation");
      enqueued.inference_job_token
    }
    Err(err) => {
      error!("Failed to use Artcraft Flux Pro 1.1 Ultra text to image generation: {:?}", err);
      return Err(GenerateError::from(err));
    }
  };

  Ok(TaskEnqueueSuccess {
    provider: GenerationProvider::Artcraft,
    task_type: TaskType::ImageGeneration,
    model: Some(GenerationModel::FluxPro11Ultra),
    provider_job_id: Some(job_token.to_string()),
  })
}

fn get_aspect_ratio(request: &EnqueueTextToImageRequest) -> Option<GenerateFluxPro11UltraTextToImageAspectRatio> {
  if let Some(common_aspect_ratio) = request.common_aspect_ratio {
    // Handle modern aspect ratio
    let aspect = aspect_ratio_to_artcraft_flux_pro_1p1_ultra(common_aspect_ratio);
    return Some(aspect);
  }

  if let Some(aspect_ratio) = request.aspect_ratio {
    // Handle deprecated aspect ratio
    let aspect = match aspect_ratio {
      TextToImageSize::Tall => GenerateFluxPro11UltraTextToImageAspectRatio::PortraitNineBySixteen,
      TextToImageSize::Wide => GenerateFluxPro11UltraTextToImageAspectRatio::LandscapeSixteenByNine,
      TextToImageSize::Square => GenerateFluxPro11UltraTextToImageAspectRatio::Square,
      TextToImageSize::Auto => GenerateFluxPro11UltraTextToImageAspectRatio::Square,
    };
    return Some(aspect);
  }

  None
}
