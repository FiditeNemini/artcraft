use crate::state::data_dir::app_data_root::AppDataRoot;
use crate::state::main_window_size::MainWindowSize;
use crate::state::storyteller::storyteller_credential_manager::StorytellerCredentialManager;
use crate::threads::main_window_thread::persist_storyteller_cookies_task::persist_storyteller_cookies_task;
use crate::threads::main_window_thread::persist_window_resize_task::persist_window_resize_task;
use errors::AnyhowResult;
use log::{error, info};
use memory_store::clone_slot::CloneSlot;
use tauri::{AppHandle, Manager, Webview, Window};
use crate::state::app_startup_time::AppStartupTime;

const MAIN_WINDOW_NAME : &str = "main";

pub async fn main_window_thread(
  app: AppHandle,
  app_data_root: AppDataRoot,
  storyteller_creds_manager: StorytellerCredentialManager,
) -> ! {
  // TODO: Move these into some kind of dependency injection framework
  let window_size_slot: CloneSlot<MainWindowSize> = CloneSlot::empty();
  let app_startup_time = AppStartupTime::new();

  loop {
    for (window_name, window) in app.windows() {
      if window_name == MAIN_WINDOW_NAME {
        let result = handle_main_window(
          &window,
          &app_data_root,
          &storyteller_creds_manager,
          &window_size_slot,
          &app_startup_time,
        ).await;
        if let Err(err) = result {
          error!("Error handling main window: {:?}", err);
        }
      }
    }
    tokio::time::sleep(std::time::Duration::from_millis(1_000)).await;
  }
}

pub async fn handle_main_window(
  window: &Window,
  app_data_root: &AppDataRoot,
  storyteller_creds_manager: &StorytellerCredentialManager,
  window_size_slot: &CloneSlot<MainWindowSize>,
  app_startup_time: &AppStartupTime,
) -> AnyhowResult<()> {
  loop {
    log_errors(persist_window_resize_task(window, app_data_root, window_size_slot).await);
    //log_errors(persist_storyteller_cookies_task(window, app_data_root, storyteller_creds_manager, app_startup_time).await);
    tokio::time::sleep(std::time::Duration::from_millis(1_000)).await;
  }
}

pub fn log_errors<T>(result: AnyhowResult<T>) {
  if let Err(err) = result {
    error!("Error persisting window size: {:?}", err);
  }
}
