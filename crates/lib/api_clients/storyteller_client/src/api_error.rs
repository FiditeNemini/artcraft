use std::error::Error;
use std::fmt::{Display, Formatter};
use errors::AnyhowError;

#[derive(Debug)]
pub enum ApiError {
  /// 400. The request was invalid.
  InvalidRequest(String),

  /// 401. The request was not authorized.
  Unauthorized(String),

  /// 403. The request was forbidden.
  Forbidden(String),

  /// 404. The requested resource was not found.
  NotFound(String),

  /// 429. Too many requests.
  TooManyRequests(String),

  /// 500. An internal server error occurred.
  InternalServerError(String),

  /// A deserialization error with the response.
  DeserializationError(serde_json::Error),

  /// The request timed out.
  Timeout(String),

  /// A network error occurred.
  NetworkError(String),

  /// Uncategorized reqwest error.
  OtherReqwestError(reqwest::Error),

  /// Another type of error.
  Other(AnyhowError),
}

impl Error for ApiError {}

impl Display for ApiError {
  fn fmt(&self, f: &mut Formatter<'_>) -> std::fmt::Result {
    match self {
      // Server response code errors
      ApiError::InvalidRequest(msg) => write!(f, "Invalid request: {}", msg),
      ApiError::Unauthorized(msg) => write!(f, "Unauthorized: {}", msg),
      ApiError::Forbidden(msg) => write!(f, "Forbidden: {}", msg),
      ApiError::NotFound(msg) => write!(f, "Not found: {}", msg),
      ApiError::TooManyRequests(msg) => write!(f, "Too many requests: {}", msg),
      ApiError::InternalServerError(msg) => write!(f, "Internal server error: {}", msg),
      // Server response handling errors
      ApiError::DeserializationError(error) => write!(f, "Deserialization error: {}", error),
      // Network errors
      ApiError::Timeout(msg) => write!(f, "Timeout: {}", msg),
      ApiError::NetworkError(msg) => write!(f, "Network error: {}", msg),
      // Other
      ApiError::OtherReqwestError(error) => write!(f, "Reqwest error: {}", error),
      ApiError::Other(error) => write!(f, "Other error: {}", error),
    }
  }
}

impl From<reqwest::Error> for ApiError {
  fn from(error: reqwest::Error) -> Self {
    if error.is_timeout() {
      ApiError::Timeout(error.to_string())
    } else if error.is_connect() {
      ApiError::NetworkError(error.to_string())
    } else {
      ApiError::OtherReqwestError(error)
    }
  }
}

impl From<serde_json::Error> for ApiError {
  fn from(error: serde_json::Error) -> Self {
    ApiError::DeserializationError(error)
  }
}
